<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我是图图小淘气</title>
    <style>
        h1 {
            color: darkred;
            font-style: italic;
            font-family: Georgia;
            text-align: center
        }

        #cf:hover {
            background-color: khaki;

        }

        #search {
            transition-duration: 0.4s;
            font-family:"Lucida Calligraphy", cursive, serif, sans-serif;
        }

        #search:hover {
            background-color: pink;
            color: yellow;
        }
        #HEAD{
            color:cornflowerblue;
            font-family:'Times New Roman', Times, serif;
        }
    </style>
</head>

<body>
    <h1><a id="cf" href="https://codeforces.com">Codeforces</a> Handles</h1>
    <form id="searchForm">
        <label id="HEAD" for="handleInput">Enter Handle:</label>
        <input type="text" id="handleInput" required>
        <button id="search" type="submit">Search</button>
    </form>
    <div id="result"></div>

    <img src="{{ url_for('static',filename='tutu.png') }}" alt="">
    <script>
        alert('面对世界很好奇')
        document.getElementById("searchForm").addEventListener("submit", function (event) {
            event.preventDefault();
            const handle = document.getElementById("handleInput").value;
            console.log(handle);
            searchInfo(handle);
        });

        function searchInfo(handle) {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", '/batchGetUserInfo?handles=' + handle);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if(xhr.status === 200)
                    {
                        const response = JSON.parse(xhr.responseText);
                        console.log(response);
                        if (response[0].success === true)
                            displayResult(response);
                        else {
                            code(response);
                        }
                    }
                    else
                    { 
                        const display = document.getElementById("result");
                        display.innerHTML = "There was an error with the request." ;
                    }
                       
                }
            };
            xhr.send();
        }

        function displayResult(data) {
            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = ""; // Clear previous result
            const playerData = data[0];
            const playerInfo = document.createElement("div");
            playerInfo.innerHTML = `
                <h2>Player Info:</h2>
                <p><b>Handle:</b> ${playerData.handle}</p>
                <p><b>Rating:</b> ${playerData.rating || 'N/A'}</p>
                <p><b>Rank:</b> ${playerData.rank || 'N/A'}</p>
            `;
            resultDiv.appendChild(playerInfo);
            if (playerData.rating)
                searchRatings(playerData.handle);
            else {
                const palyerRatings = document.createElement("div");
                palyerRatings.innerHTML = `
                <h2>Player Ratings:</h2>
                <p><b>This handle does not have a competition record</b></p>
                `;
                resultDiv.appendChild(palyerRatings);
            }
        }

        function searchRatings(handle) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", '/getUserRatings?handle=' + handle);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                const response = JSON.parse(xhr.responseText);
                console.log(response);
                displayRatings(response);
            }

        };
        xhr.send();
    }
    function displayRatings(data) {
        const resultDiv = document.getElementById("result");
        const ratingsTable = document.createElement("table");
        ratingsTable.innerHTML = `
            <caption>Rating Records:</caption>
            <tr>
                <th>Contest ID</th>
                <th>Contest Name</th>
                <th>Rank</th>
                <th>Old Rating</th>
                <th>New Rating</th>
                <th>Last Updated</th>
            </tr>
        `;
        for (const rating of data) {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${rating.contestId}</td>
                <td>${rating.contestName}</td>
                <td>${rating.rank}</td>
                <td>${rating.oldRating}</td>
                <td>${rating.newRating}</td>
                <td>${rating.ratingUpdatedAt}</td>
            `;
            ratingsTable.appendChild(row);
        }
        resultDiv.appendChild(ratingsTable);
    }


        function code(response) {
            const display = document.getElementById("result");
            display.innerHTML = "";
            display.innerHTML = response[0].message;

        }
    </script>
</body>

</html>